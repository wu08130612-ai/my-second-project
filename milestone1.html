<!DOCTYPE html>
<!-- 这行告诉浏览器这是一个HTML5文档 -->

<html lang="zh-CN">
<!-- <html>标签是整个网页的根元素，lang="zh-CN"告诉浏览器这是中文页面 -->

<head>
    <!-- <head>部分包含页面的元信息，用户看不到，但浏览器需要 -->
    
    <meta charset="UTF-8">
    <!-- 告诉浏览器使用UTF-8编码来显示中文等字符 -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 让页面在手机上也能正常显示，不会缩放 -->
    
    <title>里程碑4：2D跟随效果</title>
    <!-- 浏览器标签页上显示的标题 -->
    
    <style>
        /* CSS样式写在<style>标签里，用来控制页面的外观 */
        
        * {
            /* *号表示选择页面上的所有元素 */
            margin: 0;          /* 去掉所有元素的外边距 */
            padding: 0;         /* 去掉所有元素的内边距 */
            box-sizing: border-box;  /* 让元素的宽高计算更简单 */
        }
        
        html, body {
            /* 同时设置html和body元素的样式 */
            height: 100%;       /* 让html和body占满整个屏幕高度 */
            width: 100%;        /* 让html和body占满整个屏幕宽度 */
        }
        
        body {
            /* 专门设置body元素的样式 */
            background-color: black;  /* 设置背景颜色为黑色 */
            overflow: hidden;         /* 隐藏滚动条，确保没有多余的空白 */
            
            /* 
            ⚠️ 重要变化：移除flexbox居中布局！
            之前我们用flexbox让圆形居中，但现在JavaScript要接管位置控制
            所以我们移除了以下三行：
            display: flex;
            justify-content: center;
            align-items: center;
            
            这样圆形就不会被强制居中，JavaScript可以自由控制它的位置
            */
        }
        
        .circle {
            /* 这是我们给圆形div起的类名，用.circle来选择它 */
            width: 100px;             /* 设置宽度为100像素 */
            height: 100px;            /* 设置高度为100像素 - 宽高相等才能是正圆 */
            background-color: white;  /* 设置背景颜色为白色 */
            border-radius: 50%;       /* 关键！50%的圆角让正方形变成圆形 */
            
            /* 🎯 【修复】使用绝对定位系统，避免transform冲突 */
            position: absolute;
            /* 初始位置：屏幕中心（通过JavaScript动态设置） */
            /* 移除CSS中的静态定位，改为JavaScript动态计算 */
        }
        
        /* 
        border-radius解释：
        - 0% = 完全的直角，还是方形
        - 25% = 圆角很小的方形  
        - 50% = 完美的圆形！
        - 100% = 也是圆形，但计算方式不同
        */
    </style>
</head>

<body>
    <!-- <body>部分是用户能看到的页面内容 -->
    
    <!-- 这是我们的第一个可见元素：一个div容器 -->
    <div class="circle"></div>
    <!-- 
    解释这个div：
    - <div>是一个通用的容器元素，默认是透明的方形积木块
    - class="circle"给这个div起了个名字，让CSS能找到它并应用样式
    - </div>是结束标签，每个开始标签都要有对应的结束标签
    - 这个div里面是空的，没有文字内容，只是一个形状
    -->

    <!-- ========== 里程碑4重构：智能状态感知圆形！========== -->
    <script>
        /* 
        🧠 重构核心思想：从"无脑跟随"到"智能状态机"
        
        旧逻辑问题：window监听mousemove → 圆形无脑跟随
        新逻辑设计：圆形自身监听三个事件 → 状态驱动的智能行为
        
        状态机设计：
        1. 闲置状态：圆形静静待在屏幕正中心
        2. 追踪状态：鼠标进入圆形边界时激活，圆形跟随鼠标
        3. 归位机制：鼠标离开圆形时，立即返回中心
        */
        
        // 🛡️ 使用立即执行函数避免全局作用域return问题
        (function initializeCircleSystem() {
            // ========== 第一步：获取圆形元素 ==========
            // 🛡️ 严格的单例检查：确保只有一个圆形元素
            const circles = document.querySelectorAll('.circle');
            
            if (circles.length === 0) {
                console.error('❌ 致命错误：未找到圆形元素！');
                return; // 在函数内部可以安全使用return
            }
            
            if (circles.length > 1) {
                console.warn('⚠️ 警告：检测到多个圆形元素！');
                console.warn(`🔍 发现 ${circles.length} 个圆形元素，将使用第一个`);
                
                // 移除多余的圆形元素
                for (let i = 1; i < circles.length; i++) {
                    console.log(`🗑️ 移除多余圆形元素 #${i + 1}`);
                    circles[i].remove();
                }
            }
            
            const circle = circles[0]; // 使用第一个（也是唯一的）圆形元素
            console.log('✅ 圆形元素验证通过，单例确认！', circle);
            
            // 🎯 【新增】初始化圆形位置到屏幕中心
            const initialCenterX = window.innerWidth / 2 - 50;   // 屏幕宽度的一半减去圆形半径
            const initialCenterY = window.innerHeight / 2 - 50;  // 屏幕高度的一半减去圆形半径
            
            circle.style.left = `${initialCenterX}px`;
            circle.style.top = `${initialCenterY}px`;
            circle.style.transform = 'none'; // 确保不使用transform
            
            console.log(`🎯 圆形初始位置设置完成: 中心(${initialCenterX}, ${initialCenterY})`);
            
            // ========== 严格的元素验证与错误处理 ==========
            // 注意：由于上面已经进行了严格检查，这里的验证主要是双重保险
            if (!circle) {
                // 🚨 这种情况理论上不应该发生，但保持防御性编程
                console.error('❌ 意外错误：圆形元素引用丢失！');
                
                // 🛡️ 安全的错误提示创建（避免DOM重建）
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 20px; left: 20px; background: red; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
                errorDiv.textContent = '❌ 圆形系统初始化失败';
                document.body.appendChild(errorDiv);
                
                return; // 在函数内部可以安全使用return
            }
            console.log('✅ 智能圆形系统初始化成功！', circle);
            
            // ========== 第二步：状态管理变量 ==========
            let isTracking = false;  // 追踪状态标志
            /*
            这个变量是我们状态机的核心：
            - false: 闲置状态，圆形在中心，不响应鼠标移动
            - true: 追踪状态，圆形跟随鼠标移动
            */
            
            // ========== 第三步：事件处理函数定义 ==========
            
            // 🎯 鼠标进入事件：激活追踪状态
            function handleMouseEnter(event) {
                isTracking = true;
                console.log('🎯 追踪状态激活！圆形开始跟随鼠标');
            /*
            当鼠标指针第一次进入圆形边界时：
            1. 设置追踪标志为true
            2. 从这一刻起，mousemove事件将开始生效
            3. 圆形从"沉睡"状态变为"活跃"状态
            */
        }
        
        // 🎯 鼠标移动事件：精确追踪算法
        function handleMouseMove(event) {
            if (!isTracking) return;
            
            // 🔧 【修复】使用统一的绝对坐标系统
            // 获取鼠标相对于视口的坐标
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            
            // 🎯 【关键修复】直接使用绝对定位，避免坐标系统冲突
            // 计算圆形中心点应该在的位置（鼠标位置减去圆形半径）
            const circleX = mouseX - 50;  // 50px是圆形半径
            const circleY = mouseY - 50;
            
            // 🛠️ 【核心修复】使用绝对定位替代transform
            // 直接设置left和top，避免transform坐标系统冲突
            circle.style.left = `${circleX}px`;
            circle.style.top = `${circleY}px`;
            circle.style.transform = 'none'; // 清除transform，使用纯粹的left/top定位
            
            // 🔍 调试信息
            console.log(`🎯 精确追踪: 鼠标(${mouseX}, ${mouseY}) → 圆形中心(${circleX}, ${circleY})`);
        }
        
        // 🏠 鼠标离开事件：取消追踪，归位到中心
        function handleMouseLeave(event) {
            isTracking = false;
            
            // 🎯 【修复】统一的归位机制：使用绝对定位回到中心
            // 计算屏幕中心位置
            const centerX = window.innerWidth / 2 - 50;   // 屏幕宽度的一半减去圆形半径
            const centerY = window.innerHeight / 2 - 50;  // 屏幕高度的一半减去圆形半径
            
            // 🛠️ 使用绝对定位回到中心，保持坐标系统一致性
            circle.style.left = `${centerX}px`;
            circle.style.top = `${centerY}px`;
            circle.style.transform = 'none'; // 确保不使用transform
            
            console.log(`🏠 追踪状态取消！圆形归位到中心: (${centerX}, ${centerY})`);
        }
        
            // ========== 第四步：事件监听器绑定 ==========
            /*
            🔥 重构的核心改变：从window监听改为圆形元素监听
            
            旧方案：window.addEventListener('mousemove', handleMouseMove)
            问题：全局监听，无法区分状态
            
            新方案：为圆形元素绑定三个专门的事件监听器
            优势：精确控制，状态驱动
            */
            
            // 🛡️ 防御性编程：确保事件监听器安全绑定
            try {
                // 绑定鼠标进入事件
                circle.addEventListener('mouseenter', handleMouseEnter);
                console.log('✅ mouseenter 事件监听器绑定成功');
                
                // 绑定鼠标移动事件（注意：这是绑定在圆形上，不是window上）
                circle.addEventListener('mousemove', handleMouseMove);
                console.log('✅ mousemove 事件监听器绑定成功');
                
                // 绑定鼠标离开事件
                circle.addEventListener('mouseleave', handleMouseLeave);
                console.log('✅ mouseleave 事件监听器绑定成功');
                
            } catch (error) {
                console.error('❌ 事件监听器绑定失败：', error);
                console.error('🔍 错误详情：', error.message);
                
                // 🛡️ 安全的错误提示创建（避免DOM重建）
                 const warningDiv = document.createElement('div');
                 warningDiv.style.cssText = 'position: fixed; top: 60px; left: 20px; background: orange; color: white; padding: 10px; border-radius: 5px; z-index: 9999;';
                 warningDiv.textContent = '⚠️ 事件监听器绑定失败';
                 document.body.appendChild(warningDiv);
            }
            
            // ========== 第五步：系统启动信息 ==========
            console.log('🧠 智能圆形系统启动完成！');
            console.log('📋 交互说明：');
            console.log('   • 闲置状态：圆形静静待在屏幕中心');
            console.log('   • 鼠标进入圆形 → 激活追踪状态');
            console.log('   • 在圆形上移动鼠标 → 圆形跟随');
            console.log('   • 鼠标离开圆形 → 立即归位到中心');
            console.log('💡 试试看：将鼠标移动到圆形上！');
        
        /*
        🎉 重构完成！新系统的优势：
        
        1. 状态驱动：有明确的闲置/追踪状态
        2. 精确控制：只在需要时响应鼠标移动
        3. 智能归位：离开时自动回到中心
        4. 性能优化：减少不必要的事件处理
        5. 用户体验：更符合直觉的交互逻辑
        
        这就是从"功能实现"到"交互设计"的升级！
        */
        
        })(); // 立即执行函数结束
        
    </script>
    <!-- 智能圆形系统代码结束 -->
    <!-- JavaScript代码结束 -->

</body>

</html>